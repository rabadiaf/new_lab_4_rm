name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: self-hosted

    env:
      DEPLOYMENT_NAME: my-app7
      IMAGE_NAME: rabadiaf/k8s-lab:latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # Cache estable de la DB de Trivy (no depende de cambios en archivos)
      - name: Cache Trivy DB
        uses: actions/cache@v4
        with:
          path: ~/.cache/trivy
          key: trivy-db-${{ runner.os }}-v1
          restore-keys: |
            trivy-db-${{ runner.os }}-v1

      - name: Install Trivy (if not present)
        run: |
          if ! command -v trivy >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y wget apt-transport-https gnupg lsb-release
            wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
            echo deb https://aquasecurity.github.io/trivy-repo/deb stable main | sudo tee /etc/apt/sources.list.d/trivy.list
            sudo apt-get update
            sudo apt-get install -y trivy
          fi

      # Scan del repo y manifiestos
      - name: Trivy FS scan (repo & manifests)
        run: |
          trivy fs \
            --cache-dir ~/.cache/trivy \
            --skip-update \
            --severity HIGH,CRITICAL \
            --exit-code 1 \
            --no-progress \
            .

      # Build de la imagen Docker local
      - name: Build Docker image
        run: |
          docker build -t $IMAGE_NAME .

      # Scan de la imagen Docker construida
      - name: Trivy image scan
        run: |
          trivy image \
            --cache-dir ~/.cache/trivy \
            --skip-update \
            --severity HIGH,CRITICAL \
            --exit-code 1 \
            --no-progress \
            $IMAGE_NAME

      # Push a Docker Hub (usa usuario y password)
      - name: Login to Docker Hub
        if: env.DOCKERHUB_USERNAME && env.DOCKERHUB_PASSWORD
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}
        run: |
          echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin

      - name: Push image
        if: env.DOCKERHUB_USERNAME && env.DOCKERHUB_PASSWORD
        run: |
          docker push $IMAGE_NAME
  
      # Deploy solo si todo lo anterior pas√≥
      - name: Apply deployment
        run: kubectl apply -f deployment.yml

      - name: Describe deployment
        run: kubectl describe deploy $DEPLOYMENT_NAME

      - name: Apply pod manifest
        run: |
          echo "Creating the pod"
          kubectl apply -f pod.yml

      - name: Get pods
        run: kubectl get pods -o wide

