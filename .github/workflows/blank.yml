name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      app_prefix:
        description: "Prefijo de los deployments/Services (ej: my-app)"
        required: false
        default: "my-app"
      image_tag:
        description: "Tag de la imagen Docker (si se omite, se usa el run_number)"
        required: false
        default: ""

jobs:
  build:
    runs-on: self-hosted

    env:
      # Prefijo para deployments/Services (viene del input o default)
      APP_PREFIX: ${{ inputs.app_prefix || 'my-app' }}
      # Tag de la imagen (input o, si estÃ¡ vacÃ­o, el run_number del workflow)
      IMAGE_TAG: ${{ inputs.image_tag != '' && inputs.image_tag || github.run_number }}
      # Imagen final con tag dinÃ¡mico
      IMAGE_NAME: rabadiaf/k8s-lab:${{ inputs.image_tag != '' && inputs.image_tag || github.run_number }}
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}

    steps:

      - name: Cache Trivy DB
        uses: actions/cache@v4
        with:
          path: ~/.cache/trivy
          key: trivy-db-${{ runner.os }}-v1
          restore-keys: |
            trivy-db-${{ runner.os }}-v1

      - name: Install Trivy (if not present)
        run: |
          if ! command -v trivy >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y wget apt-transport-https gnupg lsb-release mailutils
            wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
            echo deb https://aquasecurity.github.io/trivy-repo/deb stable main | sudo tee /etc/apt/sources.list.d/trivy.list
            sudo apt-get update
            sudo apt-get install -y trivy
          fi

      - name: Prepare reports dir
        run: mkdir -p reports

      - name: Trivy FS scan (repo & manifests)
        run: |
          set -o pipefail
          trivy fs \
            --cache-dir ~/.cache/trivy \
            --skip-update \
            --severity HIGH,CRITICAL \
            --exit-code 1 \
            --no-progress \
            . | tee reports/trivy_fs.txt

      - name: Build Docker image
        run: docker build -t "$IMAGE_NAME" .

      - name: Trivy image scan
        run: |
          set -o pipefail
          trivy image \
            --cache-dir ~/.cache/trivy \
            --skip-update \
            --severity HIGH,CRITICAL \
            --exit-code 1 \
            --no-progress \
            "$IMAGE_NAME" | tee reports/trivy_image.txt

      - name: Login to Docker Hub
        run: |
          docker login -u "$DOCKERHUB_USERNAME" --password-stdin <<< "$DOCKERHUB_PASSWORD"

      - name: Push image
        run: docker push "$IMAGE_NAME"

      - name: Apply deployment
        run: kubectl apply -f deployment.yml

      # Opcional: script externo para validar deployment+service segÃºn prefix
      # Asumiendo que tienes scripts/check_deploy_and_service.sh en el repo
      - name: Check deployment and service for prefix
        run: |
          if [ -x scripts/check_deploy_and_service.sh ]; then
            echo "Ejecutando check_deploy_and_service.sh con prefix $APP_PREFIX..."
            scripts/check_deploy_and_service.sh "$APP_PREFIX"
          else
            echo "scripts/check_deploy_and_service.sh no existe o no es ejecutable, se omite."
          fi

      # ---- Describe dinÃ¡mico de todos los deployments que empiecen con APP_PREFIX ----
      - name: Describe deployments starting with prefix
        run: |
          echo "ðŸ” Checking deployments starting with '$APP_PREFIX'..."
          deps=$(kubectl get deploy --no-headers -o custom-columns=":metadata.name" | grep "^$APP_PREFIX" || true)
          if [ -z "$deps" ]; then
            echo "âš ï¸ No hay deployments que empiecen con '$APP_PREFIX'"
          else
            echo "$deps" | while read dep; do
              echo "-----------------------------------------------"
              echo "ðŸ“„ Describing $dep ..."
              kubectl describe deploy "$dep" | tee -a reports/deployments.txt
              echo "-----------------------------------------------"
            done
          fi

      - name: Apply pod manifest
        run: |
          echo "Creating the pod"
          kubectl apply -f pod.yml

      - name: Get pods
        run: |
          kubectl get pods -o wide | tee reports/pods.txt

      - name: Upload reports as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: all-reports
          path: reports/

      - name: Email reports (Trivy + Pods + Deployments)
        if: always()
        uses: dawidd6/action-send-mail@v6
        with:
          server_address: smtp.gmail.com
          server_port: 587
          secure: false
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          from:     ${{ secrets.SMTP_USERNAME }}
          to:       ${{ secrets.TO_EMAIL }}
          subject:  "CI Report â€“ ${{ github.repository }} #${{ github.run_number }}"
          body: |
            âœ… CI/CD Run Summary:
            Repository: ${{ github.repository }}
            Branch: ${{ github.ref_name }}
            Run URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            Inputs:
            - app_prefix: ${{ inputs.app_prefix || 'my-app' }}
            - image_tag:  ${{ inputs.image_tag != '' && inputs.image_tag || github.run_number }}

            Imagen construida:
            - ${{ env.IMAGE_NAME }}

            Se adjuntan los reportes generados:
            - Trivy FS Scan
            - Trivy Image Scan
            - kubectl get pods
            - kubectl describe deploy (prefijo '${{ env.APP_PREFIX }}')

            Estado final del workflow: ${{ job.status }}
          attachments: |
            reports/trivy_fs.txt
            reports/trivy_image.txt
            reports/pods.txt
            reports/deployments.txt
          nodemailerlog: true
          nodemailerdebug: true

